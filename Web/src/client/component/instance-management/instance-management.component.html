<p-dialog
  header="Instance Management"
  closeOnEscape="true"
  modal="true"
  styleClass="min-w-128"
  closable="true"
  [(visible)]="isShown"
  (onHide)="hide()"
  (close)="hide()"
>
  <div class="min-w-128">
    <messages-showcase [messages]="messages()"/>

    <form class="grid grid-cols-1 gap-4" [formGroup]="form">
      <div>
        <label for="name" class="block text-sm font-medium">Name</label>
        <input formControlName="name" pInputText type="text" id="name" class="mt-1 block w-full"/>
        <form-input-error [control]="form.controls.name"/>
      </div>

      <div>
        <label for="description" class="block text-sm font-medium">Description</label>
        <textarea formControlName="description" pTextarea id="description" class="mt-1 p-2 block w-full"></textarea>
        <form-input-error [control]="form.controls.description"/>
      </div>

      <div>
        <label for="users" class="block text-l font-bold">Users</label>
        <p-table [value]="form.controls.users.controls">
          <ng-template #header>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th class="max-w-96">Permissions</th>
              <th>Actions</th>
            </tr>
          </ng-template>
          <ng-template #body let-user let-i="rowIndex">
            <tr>
              <td>{{ user.value.email }}</td>
              <td>{{ user.value.name }}</td>
              <td>
                @if (!user.value.isOwnerOrSelf) {
                  <div>
                    <p-badge
                      *ngIf="!user.value.showPermissions"
                      value="Show permissions"
                      severity="secondary"
                      class="cursor-pointer px-2 py-1 text-xs"
                      (click)="user.value.showPermissions = true"
                    />

                    <div *ngIf="user.value.showPermissions" class="rounded p-2 max-h-60 overflow-y-auto">
                      <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold">Permissions</span>
                        <p-badge
                          value="Hide"
                          severity="danger"
                          class="cursor-pointer text-xs"
                          (click)="user.value.showPermissions = false"
                        />
                      </div>
                      <table class="w-full table-auto text-sm">
                        <tbody>
                        <tr *ngFor="let perm of user.value.permissions; let j = index">
                          <td class="pr-4 py-1">{{ perm.label }}</td>
                          <td class="py-1">
                            <p-badge
                              [value]="perm.toggled ? 'Enabled' : 'Disabled'"
                              [severity]="perm.toggled ? 'success' : 'danger'"
                              class="cursor-pointer px-2 py-1 text-xs"
                              (click)="togglePermission(i, j)"
                            />
                          </td>
                        </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                } @else {
                  <p-badge
                    value="Owner. All granted"
                    severity="success"
                    class="px-2 py-1 text-xs"
                  />
                }
              </td>
              <td>
                <p-button [disabled]="user.value.isOwnerOrSelf" variant="text" icon="pi pi-trash" (onClick)="removeUser(i)"/>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>

      <messages-showcase [messages]="messagesUsers()"/>

      <form [formGroup]="formUser" class="flex flex-row gap-x-4 mt-1 max-w-96">
        <div class="flex flex-col">
          <input formControlName="email" placeholder="Enter email..." pInputText type="email" id="email"
                 class="mt-1 block w-full"/>
          <form-input-error [control]="formUser.controls.email" [customErrorMessages]="customErrorMessages"/>
        </div>
        <p-button class="mt-1" label="Add user" [disabled]="formUser.invalid" (onClick)="addUser()"/>
      </form>
    </form>

    <div class="flex justify-end mt-4">
      <p-button [label]="instance() === undefined ? 'Create' : 'Save'" [disabled]="form.invalid || !form.dirty" (onClick)="save()"
                type="submit"/>
    </div>
  </div>
</p-dialog>
