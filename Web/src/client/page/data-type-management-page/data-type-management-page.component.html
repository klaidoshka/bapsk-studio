<div class="h-full w-full relative container mx-auto flex flex-col mb-8">
  <data-type-page-header-section [canGoBack]="true"/>
  @if (dataType.isLoading()) {
    <loading-spinner/>
  } @else if (!dataType.value()) {
    <failed-to-load-please-reload/>
  } @else {
    <card class="w-fit!">
      <p card-header>Manage Data Type</p>
      <p card-subHeader>Fill in the form below to create a new data type or modify an existing one.</p>
      <form card-body class="flex flex-col gap-4" [formGroup]="form">
        <div class="flex flex-wrap gap-4">
          <!-- Name -->
          <div>
            <p-floatlabel variant="on" class="w-60">
              <p-iconfield>
                <p-inputicon class="pi pi-tag"/>
                <input pInputText id="name" formControlName="name" type="text"/>
              </p-iconfield>
              <label for="name">Name</label>
            </p-floatlabel>
            <form-input-error [control]="form.controls.name"/>
          </div>

          <!-- Description -->
          <div>
            <p-floatlabel variant="on" class="w-60">
              <p-iconfield>
                <p-inputicon class="pi pi-comment"/>
                <input pInputText id="description" formControlName="description" type="text"/>
              </p-iconfield>
              <label for="description">Description</label>
            </p-floatlabel>
            <form-input-error [control]="form.controls.description"/>
          </div>

          <!-- Display Field -->
          <div>
            <p-floatlabel variant="on" class="w-60">
              <p-select inputId="displayField" formControlName="displayField" [options]="displayFields()"
                        optionLabel="label" optionValue="value" dropdownIcon="pi pi-book" appendTo="body"
                        styleClass="w-full"/>
              <label for="displayField">Display Field</label>
            </p-floatlabel>
            <form-input-error [control]="form.controls.displayField"/>
          </div>
        </div>
        <card>
          <p card-header>Fields</p>
          <p card-subHeader>Fields of this data type.</p>
          <p-table card-body [styleClass]="'rounded-md border border-primary-950/20 dark:border-primary-50/20 relative w-fit overflow-auto ' +
                   '[&_th]:border-b-primary-950/20! [&_th]:dark:border-primary-50/20! [&_td]:border-b-primary-950/20! [&_td]:dark:border-primary-50/20!'"
                   [value]="form.controls.fields.controls" [columns]="['Name', 'Type', 'Default Value', 'Required']"
                   formArrayName="fields">
            <ng-template #header let-columns>
              <tr>
                @for (column of columns; track $index) {
                  <th>{{ column }}</th>
                }
                <th></th>
              </tr>
            </ng-template>
            <ng-template #body let-field let-i="rowIndex">
              @let fieldType = getFieldType(i);
              @let isReference = fieldType === FieldType.Reference;
              <tr [formGroup]="field">
                <td>
                  <input formControlName="name" pInputText type="text" class="w-full"
                         [class]="{'mt-7': isReference}"/>
                </td>
                <td>
                  <p-select formControlName="type" [options]="fieldTypes" optionLabel="label" optionValue="value"
                            placeholder="Select a type" appendTo="body" styleClass="w-full"
                            [class]="{'mt-7': isReference}"/>
                </td>
                <td>
                  @if (isReference) {
                    <div class="flex flex-col">
                      <label for="referencedType" class="font-semibold">Referenced Type</label>
                      <p-select id="referencedType" placeholder="Select a referenced type"
                                formControlName="referencedType" [options]="dataTypes.value() || []"
                                optionLabel="name"
                                optionValue="id" appendTo="body" class="mt-1 w-full"/>
                    </div>
                  } @else {
                    <data-type-entry-field-input formControlName="defaultValue" [type]="fieldType"/>
                  }
                </td>
                <td>
                  <p-checkbox formControlName="isRequired" binary [styleClass]="isReference ? 'mt-7' : ''"/>
                </td>
                <td>
                  <div class="flex items-center">
                    <p-button icon="pi pi-trash" type="button" variant="text" (onClick)="removeField(i)"
                              [styleClass]="isReference ? 'mt-7' : ''"/>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </card>
        <form-input-error [control]="form.controls.fields" [customErrorMessages]="customErrorMessages"/>
        <p-button title="Add Field" size="small" label="Add Field" (onClick)="addField()"/>
        <messages-showcase [messages]="messages()"/>
        <p-button title="Submit" size="small" [label]="dataType.value() === undefined ? 'Create' : 'Save'"
                  [disabled]="form.invalid || !form.dirty" (onClick)="save()" type="submit"/>
      </form>
    </card>
  }
</div>
