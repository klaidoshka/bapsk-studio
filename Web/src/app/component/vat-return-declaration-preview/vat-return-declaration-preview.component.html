<p-dialog
  header="Sale Declaration"
  closable="true"
  closeOnEscape="true"
  modal="true"
  styleClass="min-w-128"
  (close)="hide()"
  (onHide)="hide()"
  [(visible)]="isShown"
>
  <app-confirmation key="cancel-confirmation" header="Are you sure about canceling this declaration?"/>

  <div class="flex flex-wrap gap-4" *ngIf="sale() !== undefined">
    <!-- Left Column -->
    <div class="flex-1 min-w-42 bg-surface p-4 rounded-lg shadow-md relative" *ngIf="declaration() != undefined">
      <p class="text-lg">
        <strong>Declaration Id:</strong>
        {{ declaration()!.id }}
      </p>

      <p class="text-lg">
        <strong>Declared By</strong>
        {{ toUserIdentityFullName(declaration()!.declaredBy) }}
      </p>

      <p class="text-lg">
        <strong>Submit Date:</strong>
        {{ declaration()!.submitDate | date:'short' }}
      </p>

      <p class="text-lg">
        <strong>State:</strong>
        <p-badge
          class="ml-1"
          [value]="declaration()!.isCanceled ? 'Canceled' : getSubmitDeclarationStateLabel(declaration()!.state)"
          [severity]="declaration()!.isCanceled || declaration()!.state === SubmitDeclarationState.REJECTED ? 'danger' : 'success'"
        />
      </p>

      <p *ngIf="declaration()!.correction > 1" class="text-lg">
        <strong>Corrected Times:</strong>
        {{ declaration()!.correction }}
      </p>

      <p-button
        *ngIf="!declaration()!.isCanceled"
        title="Refresh declaration"
        icon="pi pi-refresh"
        variant="text"
        class="absolute top-0 right-10 m-2"
        (click)="refresh()"
        [disabled]="isRefreshing()"
      ></p-button>

      <p-button
        *ngIf="!declaration()!.isCanceled"
        title="Cancel declaration"
        icon="pi pi-ban"
        variant="text"
        class="absolute top-0 right-0 m-2"
        (click)="cancel()"
        [disabled]="isCanceling()"
        severity="danger"
      ></p-button>
    </div>

    <!-- Right Column -->
    <div class="flex-1 min-w-42 bg-surface p-4 rounded-lg shadow-md">
      <p class="text-lg">
        <strong>Customer:</strong>
        {{ toCustomerFullName(sale()!!.customer) }}
      </p>

      <p class="text-lg">
        <strong>Salesman:</strong>
        {{ sale()!.salesman.name }}
      </p>

      <p class="text-lg">
        <strong>Sold Goods:</strong>
        {{ sale()!.soldGoods.length }} good(s)
      </p>

      <p class="text-lg">
        <strong>VAT to return:</strong>
        {{ getVATToReturn(sale()!) | currency:'EUR':'symbol':'1.2-2' }}
      </p>
    </div>
  </div>

  <div *ngIf="declaration?.() && declaration()?.qrCodes?.length" class="mt-4">
    <div class="border border-surface-300 rounded-lg shadow-md">
      <div class="bg-surface p-4 cursor-pointer flex justify-between items-center" (click)="showQrCodes.set(!showQrCodes())">
        <p class="font-bold text-lg">QR Codes</p>
        <svg class="w-6 h-6 transform transition-transform" [ngClass]="{'rotate-180': showQrCodes()}"
             xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </div>
      <div class="p-4" *ngIf="showQrCodes()">
        <div class="flex flex-wrap gap-4">
          <div
            *ngFor="let qrCode of declaration()!.qrCodes; let i = index"
            class="flex justify-center w-full sm:w-1/2 md:w-1/3 lg:w-1/4"
          >
            <img
              [src]="'data:image/png;base64,' + qrCode"
              [alt]="'Declaration\'s #' + (i + 1) + ' QR code chunk'"
              class="w-48 h-48"
            />
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mt-4 bg-surface p-4 rounded-lg shadow-md" *ngIf="sale() !== undefined">
    <p-table [value]="sale()!.soldGoods">
      <ng-template #header>
        <tr>
          <th class="text-left p-2">Sequence No</th>
          <th class="text-left p-2">Description</th>
          <th class="text-left p-2">Quantity</th>
          <th class="text-left p-2">Measure Unit</th>
          <th class="text-left p-2">Unit Price</th>
          <th class="text-left p-2">VAT Amount</th>
          <th class="text-left p-2">Total Amount</th>
        </tr>
      </ng-template>
      <ng-template
        #body
        let-soldGood
      >
        <tr>
          <td class="p-2">{{ soldGood.sequenceNo }}</td>
          <td class="p-2">{{ soldGood.description }}</td>
          <td class="p-2">{{ soldGood.quantity }}</td>
          <td class="p-2">{{ soldGood.unitOfMeasure }}</td>
          <td class="p-2">{{ soldGood.taxableAmount / soldGood.quantity | round:2 | currency:'EUR':'symbol':'1.2-2' }}</td>
          <td class="p-2">{{ soldGood.vatAmount | round:2 | currency:'EUR':'symbol':'1.2-2' }} ({{ soldGood.vatRate | round:2 }}%)</td>
          <td class="p-2">{{ soldGood.totalAmount | round:2 | currency:'EUR':'symbol':'1.2-2' }}</td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <div
    *ngIf="sale() !== undefined"
  >
    <p
      class="font-bold text-lg my-2"
      *ngIf="declaration() === undefined"
    >
      This sale does not have a submitted VAT return declaration.
    </p>

    <div class="p-4 rounded bg-primary-100 mt-4">
      <app-vat-return-declaration-submission
        [instanceId]="instanceId()"
        [sale]="sale()!"
      />
    </div>
  </div>
</p-dialog>
